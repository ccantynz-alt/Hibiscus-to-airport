name: Agent PR (Apply Patch -> PR)

on:
  workflow_dispatch:
    inputs:
      instruction:
        description: "Natural language instruction (for your records)"
        required: true
        type: string
      patch_url:
        description: "URL to a unified git patch (text/plain) generated by agents"
        required: true
        type: string
      pr_title:
        description: "PR Title"
        required: false
        default: "agent: changes"
        type: string
      auto_merge:
        description: "If true, label PR with auto-merge"
        required: false
        default: "false"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  make_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set git identity
        run: |
          git config user.name "agent-bot"
          git config user.email "agent-bot@users.noreply.github.com"

      - name: Create branch
        id: br
        run: |
          ts=$(date +%Y%m%d-%H%M%S)
          b="agent/${ts}"
          echo "branch=$b" >> $GITHUB_OUTPUT
          git checkout -b "$b"

      - name: Download patch
        run: |
          curl -fsSL "${{ inputs.patch_url }}" -o agent.patch
          test -s agent.patch

      - name: Apply patch
        run: |
          git apply --whitespace=nowarn agent.patch

      - name: Commit changes
        run: |
          git add -A
          git commit -m "${{ inputs.pr_title }}"

      - name: Push branch
        run: |
          git push origin "${{ steps.br.outputs.branch }}"

      - name: Create PR
        id: pr
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ steps.br.outputs.branch }}
          INSTRUCTION: ${{ inputs.instruction }}
          PATCHURL: ${{ inputs.patch_url }}
          PRTITLE: ${{ inputs.pr_title }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = `${owner}:${process.env.BRANCH}`;
            const base = "main";
            const title = process.env.PRTITLE;

            const body =
              `**Instruction**\n${process.env.INSTRUCTION}\n\n` +
              `**Patch URL**\n${process.env.PATCHURL}\n\n` +
              `---\nGenerated by Agent PR workflow.`;

            const res = await github.rest.pulls.create({ owner, repo, title, head, base, body });
            core.setOutput("number", String(res.data.number));
            core.setOutput("url", res.data.html_url);

      - name: Label auto-merge
        if: ${{ inputs.auto_merge == 'true' }}
        uses: actions/github-script@v7
        env:
          PRNUM: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = Number(process.env.PRNUM);
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ["auto-merge"] });

      - name: Print PR URL
        run: |
          echo "PR: ${{ steps.pr.outputs.url }}"
