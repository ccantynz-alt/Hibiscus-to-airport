name: Agent PR (Apply Patch -> PR)

on:
  workflow_dispatch:
    inputs:
      instruction:
        description: "Natural language instruction (for your records)"
        required: true
        type: string

      patch_b64:
        description: "Base64-encoded unified git patch (optional; overrides patch_url if provided)"
        required: false
        type: string

      patch_url:
        description: "Public/accessible URL to a unified git patch (used if patch_b64 not provided)"
        required: false
        type: string

      pr_title:
        description: "PR Title"
        required: false
        default: "agent: changes"
        type: string

      auto_merge:
        description: "If true, label PR with auto-merge (requires AUTO workflow enabled)"
        required: false
        default: "false"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  make_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set git identity
        run: |
          git config user.name "agent-bot"
          git config user.email "agent-bot@users.noreply.github.com"

      - name: Create branch name
        id: br
        run: |
          ts=$(date +%Y%m%d-%H%M%S)
          echo "name=agent/${ts}" >> $GITHUB_OUTPUT

      - name: Create branch
        run: |
          git checkout -b "${{ steps.br.outputs.name }}"

      - name: Materialize patch (from patch_b64 or patch_url)
        env:
          PATCH_B64: ${{ inputs.patch_b64 }}
          PATCH_URL: ${{ inputs.patch_url }}
        run: |
          set -euo pipefail
          if [ -n "${PATCH_B64}" ]; then
            echo "Using patch_b64 input"
            echo "${PATCH_B64}" | base64 -d > agent.patch
          elif [ -n "${PATCH_URL}" ]; then
            echo "Using patch_url input: ${PATCH_URL}"
            curl -fsSL "${PATCH_URL}" -o agent.patch
          else
            echo "ERROR: Provide either patch_b64 or patch_url"
            exit 2
          fi

          echo "Patch head (40 lines):"
          head -n 40 agent.patch || true

          if ! grep -qE '^(diff --git|Index:|--- a/|\+\+\+ b/)' agent.patch; then
            echo "ERROR: agent.patch does not look like a git patch."
            head -n 80 agent.patch || true
            exit 3
          fi

      - name: Apply patch (show errors)
        run: |
          git apply --whitespace=nowarn agent.patch || (echo "git apply failed" && git apply --reject --whitespace=nowarn agent.patch && exit 1)

      - name: Commit changes
        run: |
          git status
          git add -A
          git commit -m "${{ inputs.pr_title }}" || (echo "Nothing to commit" && exit 1)

      - name: Push branch
        run: |
          git push origin "${{ steps.br.outputs.name }}"

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr create --base main --head "${{ steps.br.outputs.name }}" \
            --title "${{ inputs.pr_title }}" \
            --body "**Instruction**\n${{ inputs.instruction }}\n\n**Patch URL**\n${{ inputs.patch_url }}\n\n**Notes**\n- This PR was created by the Agent PR workflow.\n- Vercel Preview Deploy should run automatically on this PR."

      - name: Optional: label auto-merge
        if: ${{ inputs.auto_merge == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = `${owner}:${{ steps.br.outputs.name }}`;
            const prs = await github.rest.pulls.list({ owner, repo, head, state: "open" });
            if (!prs.data.length) core.setFailed("Could not find PR for branch: " + head);
            const pr = prs.data[0];
            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: pr.number,
              labels: ["auto-merge"]
            });
            core.info(`Labeled PR #${pr.number} with auto-merge`);