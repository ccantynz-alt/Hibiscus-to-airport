name: Agent PR (Apply Patch -> PR)

on:
  workflow_dispatch:
    inputs:
      instruction:
        description: "Natural language instruction (for your records)"
        required: true
        type: string
      patch_url:
        description: "Public/accessible URL to a unified git patch (produced by agents)"
        required: true
        type: string
      pr_title:
        description: "PR Title"
        required: false
        default: "agent: changes"
        type: string
      auto_merge:
        description: "If true, label PR with auto-merge (requires AUTO workflow enabled)"
        required: false
        default: "false"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  make_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create branch name
        id: br
        run: |
          ts=$(date +%Y%m%d-%H%M%S)
          echo "name=agent/${ts}" >> $GITHUB_OUTPUT

      - name: Create branch
        run: |
          git checkout -b "${{ steps.br.outputs.name }}"

      - name: Download patch
        run: |
          curl -fsSL "${{ inputs.patch_url }}" -o agent.patch
          echo "Downloaded patch:"
          head -n 40 agent.patch || true

      - name: Apply patch
        run: |
          git apply --whitespace=nowarn agent.patch

      - name: Commit changes
        run: |
          git status
          git add -A
          git commit -m "${{ inputs.pr_title }}" || (echo "Nothing to commit" && exit 1)

      - name: Push branch
        run: |
          git push origin "${{ steps.br.outputs.name }}"

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.br.outputs.name }}
          title: ${{ inputs.pr_title }}
          body: |
            **Instruction**
            ${{ inputs.instruction }}

            **Patch URL**
            ${{ inputs.patch_url }}

            **Notes**
            - This PR was created by the Agent PR workflow.
            - Vercel Preview Deploy should run automatically on this PR.

      - name: Optional: label auto-merge
        if: ${{ inputs.auto_merge == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            // Add label "auto-merge" to the PR created by peter-evans action.
            // We find the most recent open PR from this branch.
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = `${owner}:${{ steps.br.outputs.name }}`;
            const prs = await github.rest.pulls.list({
              owner, repo, head, state: "open"
            });
            if (!prs.data.length) core.setFailed("Could not find PR for branch: " + head);
            const pr = prs.data[0];
            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: pr.number,
              labels: ["auto-merge"]
            });
            core.info(`Labeled PR #${pr.number} with auto-merge`);